<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="IT Tech"><title>基于swoole PHP实现EDP协议服务端 | Maomao's</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/blog/public/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/blog/public/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/blog/public/favicon.ico"><link rel="bookmark" href="/blog/public/favicon.ico"><link rel="apple-touch-icon" href="/blog/public/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/public/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于swoole PHP实现EDP协议服务端</h1><a id="logo" href="/blog/public/.">Maomao's</a><p class="description">专注IT、物联网</p></div><div id="nav-menu"><a href="/blog/public/." class="current"><i class="fa fa-home"> Home</i></a><a href="/blog/public/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/blog/public/about/"><i class="fa fa-user"> About</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Temporarily Closed"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">基于swoole PHP实现EDP协议服务端</h1><div class="post-meta"><a href="/blog/public/cjq6du8ge002cjkutaqp8my3h.html#comments" class="comment-count"></a><p><span class="date">May 11, 2018</span><span><a href="/blog/public/categories/PHP/" class="category">PHP</a></span></p></div><div class="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&emsp;&emsp;EDP（Enhanced Device Protocol）协议是一种极简的设备协议，主要用于物联网设备，并且比MQTT还要轻量，其协议文档可以在中移动OneNET官方网站下载。</p>
<p><a href="https://open.iot.10086.cn" target="_blank" rel="external">https://open.iot.10086.cn</a></p>
<p>&emsp;&emsp;现在主要来讲讲怎么用PHP长连接方式实现一个简易的EDP协议，也是大概两年多前闲着没事自娱自乐做的一个小东西，以期更快地了解、理解这个协议。因当时暂未把QOS纳入该协议且作为大平台成员已知设备间命令会存在安全问题故PHP版本不包含QOS以及设备间命令功能。</p>
<h2 id="技术准备"><a href="#技术准备" class="headerlink" title="技术准备"></a>技术准备</h2><h3 id="一个合适的常驻内存运行的PHP框架"><a href="#一个合适的常驻内存运行的PHP框架" class="headerlink" title="一个合适的常驻内存运行的PHP框架"></a>一个合适的常驻内存运行的PHP框架</h3><p>&emsp;&emsp;可以使用原生的PHP Socket，也可以用国外的walkman之类的框架。当然，本篇是用的国产的swoole框架，各有各的优点也各有各的缺点，适合的就是好用的。</p>
<h3 id="两个重要PHP内置方法"><a href="#两个重要PHP内置方法" class="headerlink" title="两个重要PHP内置方法"></a>两个重要PHP内置方法</h3><p>&emsp;&emsp;hex2bin()与bin2hex()，对这两个方法不很清楚的童鞋可以去php.net官网看看说明</p>
<h3 id="一个进制转换方法"><a href="#一个进制转换方法" class="headerlink" title="一个进制转换方法"></a>一个进制转换方法</h3><p>&emsp;&emsp;由于世界上最好的语言的超级字符串特性，通常在数据处理的时候需要将16进制与待处理数据进行转换，方法如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * arr=1，正(小端)，arr=2，反(大端)</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span></span></div><div class="line"><span class="comment">     *            N byte array $num</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">c16to10</span><span class="params">($num, $arr = <span class="number">2</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $res = $num;</div><div class="line">        <span class="keyword">if</span> (is_array($num)) &#123;</div><div class="line">            <span class="keyword">foreach</span> ($num <span class="keyword">as</span> $p =&gt; $v) &#123;</div><div class="line">                <span class="keyword">switch</span> (strtoupper($num[$p])) &#123;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'A'</span>:</div><div class="line">                        $num[$p] = <span class="number">10</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'B'</span>:</div><div class="line">                        $num[$p] = <span class="number">11</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'C'</span>:</div><div class="line">                        $num[$p] = <span class="number">12</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'D'</span>:</div><div class="line">                        $num[$p] = <span class="number">13</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'E'</span>:</div><div class="line">                        $num[$p] = <span class="number">14</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> <span class="string">'F'</span>:</div><div class="line">                        $num[$p] = <span class="number">15</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            $res = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> ($arr == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">for</span> ($p = <span class="number">0</span>; $p &lt; count($num, COUNT_NORMAL); $p ++) &#123;</div><div class="line">    </div><div class="line">                    $res = $res + $num[$p] * pow(<span class="number">16</span>, $p);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> ($p = count($num, COUNT_NORMAL) - <span class="number">1</span>; $p &gt;= <span class="number">0</span>; $p --) &#123;</div><div class="line">    </div><div class="line">                    $res = $res + $num[$p] * pow(<span class="number">16</span>, count($num, COUNT_NORMAL) - <span class="number">1</span> - $p);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">        <span class="keyword">return</span> $res;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="看文档做解析"><a href="#看文档做解析" class="headerlink" title="看文档做解析"></a>看文档做解析</h2><h3 id="怎样才能将设备上报的数据转换成方便操作的数据"><a href="#怎样才能将设备上报的数据转换成方便操作的数据" class="headerlink" title="怎样才能将设备上报的数据转换成方便操作的数据"></a>怎样才能将设备上报的数据转换成方便操作的数据</h3><p>&emsp;&emsp;有了上面三项准备接下来可以真正开始做事情了，需要做的就是对照EDP文档进行一步一步地一个字节一个字节地解析：<br>&emsp;&emsp;1.将接收到的数据使用bin2hex转换成字符串<br>&emsp;&emsp;2.使用c16to10方法转换字符串得到相对更好处理的十进制字符串<br>&emsp;&emsp;经过以上两步得到的就是数字型字符串了，PHP中当然不区分这些，直接当作数字拿来使用即可</p>
<h3 id="处理消息类型（第一个字节）"><a href="#处理消息类型（第一个字节）" class="headerlink" title="处理消息类型（第一个字节）"></a>处理消息类型（第一个字节）</h3><p>&emsp;&emsp;根据文档消息头第一个字节为消息类型，bit4为1表示连接请求，bit4与bit5为1表示透传数据，bit7为1表示储存数据，除了这三个位意外其他的都是填充0，那么我们可以根据转换过后的数字来进行判断，如连接请求类型为00010000，通过c16to10方法后就是数字16，同样地，透传则为00110000=48，储存则是10000000=128。再通过if或者switch等方法就可以进行后面的数据处理了。</p>
<h3 id="连接鉴权的处理"><a href="#连接鉴权的处理" class="headerlink" title="连接鉴权的处理"></a>连接鉴权的处理</h3><p>&emsp;&emsp;从第十一个字节开始，后续分别是两个字节的设备长度，设备长度字节的设备ID号，然后是两个字节的鉴权长度以及鉴权长度字节的鉴权信息，以获取设备id长度为例，代码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//$cmd代表收到的二进制数据，cursor代表要去获取数据的游标</span></div><div class="line">       <span class="comment">//获取dev_id长度</span></div><div class="line">       $dev_length = Helper_Arr::c16to10([$cmd[$cursor], $cmd[$cursor+<span class="number">1</span>], $cmd[$cursor+<span class="number">2</span>], $cmd[$cursor+<span class="number">3</span>]]);</div><div class="line">       $cursor = $cursor + <span class="number">4</span>;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;最后为了方便处理心跳包，使用memcache设置一个用户识别hash：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$cache = Cache_Memcached::getInstance();</div><div class="line"> $c_key = md5(<span class="string">'edp_conn'</span> . $fd);</div><div class="line"> $cache-&gt;set($c_key, $auth_str, <span class="number">300</span>);</div><div class="line"> $c_key = md5(<span class="string">'edp_fd'</span> . $fd);</div><div class="line"> $cache-&gt;set($c_key, $dev_id, <span class="number">300</span>);</div></pre></td></tr></table></figure></p>
<h3 id="心跳包的处理"><a href="#心跳包的处理" class="headerlink" title="心跳包的处理"></a>心跳包的处理</h3><p>&emsp;&emsp;同之前的鉴权处理，如果从缓存不能获取到了用户识别hash则认为已经断线了（socket超时设置需同缓存时间一致）<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dealPing</span><span class="params">($fd, $cmd)</span></span>&#123;</div><div class="line">    $cache = Cache_Memcached::getInstance();</div><div class="line">    $c_key = md5(<span class="string">'edp_conn'</span> . $fd);</div><div class="line">    $res = $cache-&gt;get($c_key);</div><div class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($res))&#123;</div><div class="line">        $cache-&gt;set($c_key, $res, <span class="number">300</span>);</div><div class="line">        $c_key = md5(<span class="string">'edp_fd'</span> . $fd);</div><div class="line">        $res = $cache-&gt;get($c_key);</div><div class="line">        $cache-&gt;set($c_key, $res, <span class="number">300</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">'d000'</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'20020002'</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="完整示例："><a href="#完整示例：" class="headerlink" title="完整示例："></a>完整示例：</h3><ul>
<li><p>接入机<br>&emsp;&emsp;使用CGI的方式执行接入机文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_SERVER[<span class="string">'REQUEST_URI'</span>])) &#123;</div><div class="line">    <span class="keyword">exit</span>();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// set_time_limit(0);</span></div><div class="line">ini_set(<span class="string">'memory_limit'</span>, <span class="string">'128M'</span>);</div><div class="line">date_default_timezone_set(<span class="string">"Asia/Chongqing"</span>);</div><div class="line">define(<span class="string">"ROOT"</span>, realpath(dirname(<span class="keyword">__FILE__</span>)));</div><div class="line"><span class="comment">// define("ROOT_APP", realpath(ROOT . "/../app"));</span></div><div class="line"></div><div class="line"><span class="comment">// 加载APPLIB基础bootstrap</span></div><div class="line"><span class="keyword">require_once</span> (ROOT . <span class="string">'/../libs/AppLib/bootstrap.php'</span>);    <span class="comment">//该文件主要作用为自动加载相关的包、方法等，因附属框架太复杂此处不放出。如果后续有使用PSR0类型的自动加载方式，自行修改代码手动加载即可</span></div><div class="line"></div><div class="line"><span class="comment">// 开始</span></div><div class="line"></div><div class="line">$request_server = <span class="keyword">new</span> requestServer(<span class="number">29876</span>);	<span class="comment">//29876为监听的端口</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">requestServer</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $url_pre = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> $serv;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $log_file = <span class="string">'/tmp/EDP.log'</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($port)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $dev_hostnames = <span class="keyword">array</span>(</div><div class="line">            <span class="string">'test-VirtualBox'</span>,</div><div class="line">        );</div><div class="line">        $test_hostnames = <span class="keyword">array</span>(</div><div class="line">            <span class="string">'OneNetTest_node02'</span></div><div class="line">        );</div><div class="line">        $current_host_name = php_uname(<span class="string">'n'</span>);</div><div class="line">        <span class="keyword">if</span> (in_array($current_host_name, $dev_hostnames)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;url_pre = <span class="string">'127.0.0.1'</span>;</div><div class="line">            $mem_connect_addr = <span class="string">'127.0.0.1'</span>;</div><div class="line">        &#125; <span class="keyword">elseif</span> (in_array($current_host_name, $test_hostnames)) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;url_pre = <span class="string">'127.0.0.1'</span>;</div><div class="line">            $mem_connect_addr = <span class="string">'127.0.0.1'</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;url_pre = <span class="string">'127.0.0.1'</span>;</div><div class="line">            $mem_connect_addr = <span class="string">'127.0.0.1'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//此处根据三种开发环境配置三种不同配置文件，如果只有一种则直接写死即可</span></div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;serv = <span class="keyword">new</span> swoole_server(<span class="string">"0.0.0.0"</span>, $port);</div><div class="line">        </div><div class="line">        <span class="keyword">$this</span>-&gt;serv-&gt;set(<span class="keyword">array</span>(</div><div class="line">            </div><div class="line">            <span class="string">'log_file'</span> =&gt; <span class="keyword">$this</span>-&gt;log_file,</div><div class="line">            <span class="string">'heartbeat_check_interval'</span> =&gt; <span class="number">280</span>,</div><div class="line">            <span class="string">'heartbeat_idle_time'</span> =&gt; <span class="number">300</span>,</div><div class="line">            </div><div class="line">            <span class="comment">// 'user' =&gt; 'apache', //监听1024以下端口时以xxx用户的权限来运行</span></div><div class="line">            <span class="comment">// 'group' =&gt; 'www-data',</span></div><div class="line">            <span class="string">'worker_num'</span> =&gt; <span class="number">8</span>,</div><div class="line">            <span class="string">'daemonize'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">            <span class="string">'max_request'</span> =&gt; <span class="number">10000</span>,</div><div class="line">            <span class="string">'dispatch_mode'</span> =&gt; <span class="number">2</span></div><div class="line">        ));</div><div class="line">        <span class="keyword">$this</span>-&gt;serv-&gt;on(<span class="string">'Connect'</span>, <span class="keyword">array</span>(</div><div class="line">            <span class="keyword">$this</span>,</div><div class="line">            <span class="string">'onConnect'</span></div><div class="line">        ));</div><div class="line">        <span class="keyword">$this</span>-&gt;serv-&gt;on(<span class="string">'Receive'</span>, <span class="keyword">array</span>(</div><div class="line">            <span class="keyword">$this</span>,</div><div class="line">            <span class="string">'onReceive'</span></div><div class="line">        ));</div><div class="line">        <span class="keyword">$this</span>-&gt;serv-&gt;on(<span class="string">'Close'</span>, <span class="keyword">array</span>(</div><div class="line">            <span class="keyword">$this</span>,</div><div class="line">            <span class="string">'onClose'</span></div><div class="line">        ));</div><div class="line">        <span class="keyword">$this</span>-&gt;serv-&gt;start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onConnect</span><span class="params">(swoole_server $request_server, $fd)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// echo "server: handshake success with fd&#123;$fd&#125;\n";</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onReceive</span><span class="params">(swoole_server $request_server, $fd, $from_id, $data)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($cache))&#123;</div><div class="line">            $cache = Cache_Memcached::getInstance();</div><div class="line">        &#125;</div><div class="line">        $cache-&gt;set(<span class="string">"edp_ip"</span> . $fd,$request_server-&gt;connection_info($fd)[<span class="string">'remote_ip'</span>], <span class="number">300</span>);</div><div class="line">        $ret_msg = <span class="keyword">$this</span>-&gt;__dealCmd($fd, $data);</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">empty</span>($ret_msg)) &#123;</div><div class="line">            $request_server-&gt;send($fd, hex2bin($ret_msg));</div><div class="line">        &#125;</div><div class="line">        $deal_code = Service_Edp_Dealcode::dealCode($ret_msg);</div><div class="line">        <span class="keyword">if</span> ($deal_code !== <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (! <span class="keyword">empty</span>($deal_code)) &#123;</div><div class="line">                $request_server-&gt;send($fd, hex2bin($deal_code));</div><div class="line">            &#125;</div><div class="line">            $request_server-&gt;close($fd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">($ser, $fd)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// echo "client &#123;$fd&#125; closed\n";</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__dealCmd</span><span class="params">($fd, $cmd)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $cmd = bin2hex($cmd);</div><div class="line">        </div><div class="line">        $command = Helper_Arr::c16to10([</div><div class="line">            $cmd[<span class="number">0</span>],</div><div class="line">            $cmd[<span class="number">1</span>]</div><div class="line">        ]);</div><div class="line">        </div><div class="line">        <span class="keyword">switch</span> ($command) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">16</span>:</div><div class="line">                <span class="keyword">return</span> Service_Edp_Connect::dealConnect($fd, $cmd);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">128</span>:</div><div class="line">                <span class="keyword">return</span> Service_Edp_Datas::save($fd, $cmd);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">192</span>:</div><div class="line">                <span class="keyword">return</span> Service_Edp_Connect::dealPing($fd, $cmd);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> <span class="string">'400104'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_log</span><span class="params">($msg)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// echo 'log: ' . $msg . "\n";</span></div><div class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;log_file, date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">' - '</span> . $msg . <span class="string">"\n"</span>, FILE_APPEND);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>处理鉴权和心跳</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service_Edp_Connect</span> <span class="keyword">extends</span> <span class="title">Service_Base</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">       </div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dealConnect</span><span class="params">($fd, $cmd)</span></span>&#123;</div><div class="line">        $cursor = <span class="number">22</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//获取dev_id长度</span></div><div class="line">        $dev_length = Helper_Arr::c16to10([$cmd[$cursor], $cmd[$cursor+<span class="number">1</span>], $cmd[$cursor+<span class="number">2</span>], $cmd[$cursor+<span class="number">3</span>]]);</div><div class="line">        $cursor = $cursor + <span class="number">4</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//取dev_id</span></div><div class="line">        $temp = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> ($i =<span class="number">0</span>; $i&lt;$dev_length*<span class="number">2</span>;$i++)&#123;</div><div class="line">            $temp .= $cmd[$cursor+$i] . <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">        $dev_id = hex2bin($temp);</div><div class="line">        $cursor = $cursor + $dev_length*<span class="number">2</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//鉴权信息长度</span></div><div class="line">        $auth_length = Helper_Arr::c16to10([$cmd[$cursor], $cmd[$cursor+<span class="number">1</span>], $cmd[$cursor+<span class="number">2</span>], $cmd[$cursor+<span class="number">3</span>]]);</div><div class="line">        $cursor = $cursor + <span class="number">4</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//鉴权信息(api-key)</span></div><div class="line">        $temp = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> ($i =<span class="number">0</span>; $i&lt;$auth_length*<span class="number">2</span>;$i++)&#123;</div><div class="line">            $temp .= $cmd[$cursor+$i] . <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">        $auth_str = hex2bin($temp);</div><div class="line">        $cursor = $cursor + $auth_length*<span class="number">2</span>;</div><div class="line">        </div><div class="line">        <span class="comment">//开始鉴权</span></div><div class="line">        $auth = [</div><div class="line">            <span class="string">'dev_id'</span> =&gt; $dev_id,</div><div class="line">            <span class="string">'api-key'</span> =&gt; $auth_str</div><div class="line">        ];</div><div class="line">        <span class="keyword">if</span>(Service_Device::checkAuth($auth))&#123;</div><div class="line">            $cache = Cache_Memcached::getInstance();</div><div class="line">            $c_key = md5(<span class="string">'edp_conn'</span> . $fd);</div><div class="line">            $cache-&gt;set($c_key, $auth_str, <span class="number">300</span>);</div><div class="line">            $c_key = md5(<span class="string">'edp_fd'</span> . $fd);</div><div class="line">            $cache-&gt;set($c_key, $dev_id, <span class="number">300</span>);</div><div class="line">            <span class="keyword">return</span> <span class="string">'20020000'</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'20020002'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dealPing</span><span class="params">($fd, $cmd)</span></span>&#123;</div><div class="line">        $cache = Cache_Memcached::getInstance();</div><div class="line">        $c_key = md5(<span class="string">'edp_conn'</span> . $fd);</div><div class="line">        $res = $cache-&gt;get($c_key);</div><div class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($res))&#123;</div><div class="line">            $cache-&gt;set($c_key, $res, <span class="number">300</span>);</div><div class="line">            $c_key = md5(<span class="string">'edp_fd'</span> . $fd);</div><div class="line">            $res = $cache-&gt;get($c_key);</div><div class="line">            $cache-&gt;set($c_key, $res, <span class="number">300</span>);</div><div class="line">            <span class="keyword">return</span> <span class="string">'d000'</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'20020002'</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>保存上传数据到kafka</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service_Edp_Datas</span> <span class="keyword">extends</span> <span class="title">Service_Base</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($fd, $cmd)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $cursor = <span class="number">2</span>;</div><div class="line">        $cache = Cache_Memcached::getInstance();</div><div class="line">        </div><div class="line">        <span class="comment">// 先分离消息体长度</span></div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">4</span>; $i ++) &#123;</div><div class="line">            $body_length_fenli = Helper_Arr::c16to10([</div><div class="line">                $cmd[$cursor],</div><div class="line">                $cmd[$cursor + <span class="number">1</span>]</div><div class="line">            ]) &amp; <span class="number">0x80</span>;</div><div class="line">            $cursor = $cursor + <span class="number">2</span>;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($body_length_fenli)) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 过滤固定选项：标识</span></div><div class="line">        $fix_note = Helper_Arr::c16to10([</div><div class="line">            $cmd[$cursor],</div><div class="line">            $cmd[$cursor + <span class="number">1</span>]</div><div class="line">        ]);</div><div class="line">        $cursor = $cursor + <span class="number">2</span>;</div><div class="line">        </div><div class="line">        $note_no = <span class="string">''</span>;</div><div class="line">        <span class="comment">// 如果有目标或源地址，开始</span></div><div class="line">        <span class="keyword">if</span> ($fix_note == <span class="number">128</span> || $fix_note == <span class="number">192</span>) &#123;</div><div class="line">            <span class="comment">// 目的或源地址 - 长度</span></div><div class="line">            $addr_length = Helper_Arr::c16to10([</div><div class="line">                $cmd[$cursor],</div><div class="line">                $cmd[$cursor + <span class="number">1</span>],</div><div class="line">                $cmd[$cursor + <span class="number">2</span>],</div><div class="line">                $cmd[$cursor + <span class="number">3</span>]</div><div class="line">            ]);</div><div class="line">            $cursor = $cursor + <span class="number">4</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// 目的或源地址 - 具体内容</span></div><div class="line">            $temp = <span class="string">""</span>;</div><div class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $addr_length * <span class="number">2</span>; $i ++) &#123;</div><div class="line">                $temp .= $cmd[$cursor + $i] . <span class="string">""</span>;</div><div class="line">            &#125;</div><div class="line">            $addr = hex2bin($temp);</div><div class="line">            $cursor = $cursor + $addr_length * <span class="number">2</span>;</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> ($fix_note == <span class="number">192</span>) &#123;</div><div class="line">                $note_no = $cmd[$cursor] . $cmd[$cursor + <span class="number">1</span>] . $cmd[$cursor + <span class="number">2</span>] . $cmd[$cursor + <span class="number">3</span>];</div><div class="line">                $cursor = $cursor + <span class="number">4</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;        <span class="comment">// 如果有目标或源地址，结束</span></div><div class="line">        <span class="keyword">elseif</span> ($fix_note == <span class="number">0</span>) &#123;</div><div class="line">            $c_key = md5(<span class="string">'edp_fd'</span> . $fd);</div><div class="line">            $addr = $cache-&gt;get($c_key);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($addr)) &#123;</div><div class="line">                $addr = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($fix_note == <span class="number">64</span>) &#123;</div><div class="line">                $note_no = $cmd[$cursor] . $cmd[$cursor + <span class="number">1</span>] . $cmd[$cursor + <span class="number">2</span>] . $cmd[$cursor + <span class="number">3</span>];</div><div class="line">                $cursor = $cursor + <span class="number">4</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'20020002'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果没有目标或源地址，结束</span></div><div class="line">        </div><div class="line">        <span class="comment">// //消息编号（似乎没有）</span></div><div class="line">        <span class="comment">// $msg_id = Helper_Arr::c16to10([$cmd[$cursor], $cmd[$cursor+1], $cmd[$cursor+2], $cmd[$cursor+3]]);</span></div><div class="line">        <span class="comment">// $cursor = $cursor + 4;</span></div><div class="line">        </div><div class="line">        <span class="comment">// 数据消息类型</span></div><div class="line">        $data_type = Helper_Arr::c16to10([</div><div class="line">            $cmd[$cursor],</div><div class="line">            $cmd[$cursor + <span class="number">1</span>]</div><div class="line">        ]);</div><div class="line">        $cursor = $cursor + <span class="number">2</span>;</div><div class="line">        <span class="comment">// 数据消息 - 长度</span></div><div class="line">        $data_length = Helper_Arr::c16to10([</div><div class="line">            $cmd[$cursor],</div><div class="line">            $cmd[$cursor + <span class="number">1</span>],</div><div class="line">            $cmd[$cursor + <span class="number">2</span>],</div><div class="line">            $cmd[$cursor + <span class="number">3</span>]</div><div class="line">        ]);</div><div class="line">        $cursor = $cursor + <span class="number">4</span>;</div><div class="line">        </div><div class="line">        <span class="comment">// 数据消息 - 具体内容</span></div><div class="line">        $temp = <span class="string">""</span>;</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $data_length * <span class="number">2</span>; $i ++) &#123;</div><div class="line">            $temp .= $cmd[$cursor + $i] . <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        $data_body = hex2bin($temp);</div><div class="line">        $cursor = $cursor + $data_length * <span class="number">2</span>;</div><div class="line">        </div><div class="line">        <span class="comment">// 是二进制数据，特殊处理</span></div><div class="line">        <span class="keyword">if</span> ($data_type == <span class="number">2</span>) &#123;</div><div class="line">            $data_bin_length = Helper_Arr::c16to10([</div><div class="line">                $cmd[$cursor],</div><div class="line">                $cmd[$cursor + <span class="number">1</span>],</div><div class="line">                $cmd[$cursor + <span class="number">2</span>],</div><div class="line">                $cmd[$cursor + <span class="number">3</span>],</div><div class="line">                $cmd[$cursor + <span class="number">4</span>],</div><div class="line">                $cmd[$cursor + <span class="number">5</span>],</div><div class="line">                $cmd[$cursor + <span class="number">6</span>],</div><div class="line">                $cmd[$cursor + <span class="number">7</span>]</div><div class="line">            ]);</div><div class="line">            $cursor = $cursor + <span class="number">8</span>;</div><div class="line">            </div><div class="line">            $temp = <span class="string">""</span>;</div><div class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $data_bin_length * <span class="number">2</span>; $i ++) &#123;</div><div class="line">                $temp .= $cmd[$cursor + $i] . <span class="string">""</span>;</div><div class="line">            &#125;</div><div class="line">            $data_bin_body = hex2bin($temp);</div><div class="line">            $cursor = $cursor + $data_bin_length * <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// --------------EDP包解析结束--------------//</span></div><div class="line">        <span class="comment">// 数据鉴权</span></div><div class="line">        $c_key = md5(<span class="string">'edp_conn'</span> . $fd);</div><div class="line">        $auth_str = $cache-&gt;get($c_key);</div><div class="line">        <span class="keyword">if</span> (! <span class="keyword">empty</span>($auth_str)) &#123;</div><div class="line">            </div><div class="line">            $kafka_array = [];</div><div class="line">            $kafka_array[<span class="string">'datastreams'</span>] = [];</div><div class="line">            </div><div class="line">            <span class="keyword">switch</span> ($data_type) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    $kafka_array = json_decode($data_body, <span class="keyword">TRUE</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    </div><div class="line">                    <span class="comment">// 二进制数据</span></div><div class="line">                    $input_data = json_decode($data_body, <span class="keyword">TRUE</span>);</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($input_data) || ! is_array($input_data)) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="string">'20020001'</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (is_array($input_data)) &#123;</div><div class="line">                        $kafka_array[<span class="string">'datastreams'</span>][<span class="number">0</span>][<span class="string">'id'</span>] = $input_data[<span class="string">'ds_id'</span>];</div><div class="line">                        $kafka_array[<span class="string">'datastreams'</span>][<span class="number">0</span>][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = <span class="keyword">empty</span>($input_data[<span class="string">'at'</span>]) ? date(<span class="string">'Y-m-d\TH:i:s'</span>) : $input_data[<span class="string">'at'</span>];</div><div class="line">                        $kafka_array[<span class="string">'datastreams'</span>][<span class="number">0</span>][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $data_bin_body;</div><div class="line">                        $kafka_array[<span class="string">'datastreams'</span>][<span class="number">0</span>][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'desc'</span>] = $input_data[<span class="string">'desc'</span>];</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                    $input_data = json_decode($data_body, <span class="keyword">TRUE</span>);</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($input_data) || ! is_array($input_data)) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="string">'20020001'</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (is_array($input_data)) &#123;</div><div class="line">                        $count = <span class="number">0</span>;</div><div class="line">                        <span class="keyword">foreach</span> ($input_data <span class="keyword">as</span> $p =&gt; $v) &#123;</div><div class="line">                            $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'id'</span>] = $p;</div><div class="line">                            $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = date(<span class="string">'Y-m-d\TH:i:s'</span>);</div><div class="line">                            $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $v;</div><div class="line">                            $count ++;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">                    $input_data = json_decode($data_body, <span class="keyword">TRUE</span>);</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">empty</span>($input_data) || ! is_array($input_data)) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="string">'20020001'</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (is_array($input_data)) &#123;</div><div class="line">                        $count = <span class="number">0</span>;</div><div class="line">                        <span class="keyword">foreach</span> ($input_data <span class="keyword">as</span> $p =&gt; $v) &#123;</div><div class="line">                            $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'id'</span>] = $p;</div><div class="line">                            <span class="keyword">if</span> (is_array($input_data[$p])) &#123;</div><div class="line">                                <span class="keyword">foreach</span> ($input_data[$p] <span class="keyword">as</span> $p2 =&gt; $v2) &#123;</div><div class="line">                                    $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = $p2;</div><div class="line">                                    $kafka_array[<span class="string">'datastreams'</span>][$count][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $v2;</div><div class="line">                                &#125;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                <span class="keyword">return</span> <span class="string">'20020001'</span>;</div><div class="line">                            &#125;</div><div class="line">                            $count ++;</div><div class="line">                        &#125; <span class="comment">// foreach inputdata</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">                    $split1 = mb_substr($data_body, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">                    $split2 = mb_substr($data_body, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">                    $real_str = mb_substr($data_body, <span class="number">2</span>, strlen($data_body) - <span class="number">2</span>);</div><div class="line">                    $ds_array = explode($split2, $real_str);</div><div class="line">                    <span class="keyword">if</span> (is_array($ds_array)) &#123;</div><div class="line">                        <span class="keyword">foreach</span> ($ds_array <span class="keyword">as</span> $p =&gt; $v) &#123;</div><div class="line">                            $dp_array = explode($split1, $v);</div><div class="line">                            <span class="keyword">if</span> (count($dp_array, COUNT_NORMAL) == <span class="number">2</span>) &#123;</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'id'</span>] = $dp_array[<span class="number">0</span>];</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = date(<span class="string">'Y-m-d\TH:i:s'</span>);</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $dp_array[<span class="number">1</span>];</div><div class="line">                            &#125; <span class="keyword">elseif</span> (count($dp_array, COUNT_NORMAL) == <span class="number">1</span>) &#123;</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'id'</span>] = $p;</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = date(<span class="string">'Y-m-d\TH:i:s'</span>);</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $dp_array[<span class="number">0</span>];</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'id'</span>] = $dp_array[<span class="number">0</span>];</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'at'</span>] = $dp_array[<span class="number">1</span>];</div><div class="line">                                $kafka_array[<span class="string">'datastreams'</span>][$p][<span class="string">'datapoints'</span>][<span class="number">0</span>][<span class="string">'value'</span>] = $dp_array[<span class="number">2</span>];</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="comment">// if ds is array</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="comment">// switch</span></div><div class="line">            $auth = [</div><div class="line">                <span class="string">'dev_id'</span> =&gt; $addr,</div><div class="line">                <span class="string">'api-key'</span> =&gt; $auth_str</div><div class="line">            ];</div><div class="line">            $ip = $cache-&gt;get(<span class="string">"edp_ip"</span> . $fd);</div><div class="line">            <span class="keyword">if</span> (! Helper_Kafka::sendToDp($auth, $kafka_array, <span class="keyword">TRUE</span>, $ip)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">'20020001'</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">empty</span>($note_no))&#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">'900440'</span> . $note_no . <span class="string">'00'</span>;</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="string">''</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'20020002'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>相关的其他支持类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service_Edp_Dealcode</span> <span class="keyword">extends</span> <span class="title">Service_Base</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dealCode</span><span class="params">($code)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $code = strtolower($code);</div><div class="line">        <span class="keyword">if</span> (strlen($code) &gt; <span class="number">10</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($code == <span class="string">'d000'</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($code == <span class="string">'20020000'</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($code == <span class="string">''</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">elseif</span> ($code == <span class="string">'20020002'</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'400120'</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'400101'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache_Memcached</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $_objList;</div><div class="line">    <span class="keyword">private</span> $_memcache;</div><div class="line">    <span class="keyword">private</span> $_config_name;</div><div class="line">    </div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($config_name)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;_config_name = $config_name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line"></div><div class="line">        $memcacheHosts = Config::get(<span class="keyword">$this</span>-&gt;_config_name);</div><div class="line">        $memcacheHosts = explode(<span class="string">','</span>, $memcacheHosts);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($memcacheHosts)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;_memcache = <span class="keyword">new</span> Memcache;</div><div class="line">            <span class="keyword">foreach</span> ($memcacheHosts <span class="keyword">as</span> $m) &#123;</div><div class="line">                <span class="keyword">list</span>($host, $port) = explode(<span class="string">':'</span>, $m);</div><div class="line">                <span class="keyword">$this</span>-&gt;_memcache-&gt;addServer($host, $port);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取一个Cache_Memcache实例</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $clusterId cluster id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">($config_name = <span class="string">'DefaultMemcacheServers'</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$_objList[$config_name])) &#123;</div><div class="line">            $obj = <span class="keyword">new</span> <span class="keyword">self</span>($config_name);</div><div class="line">            $obj-&gt;init();</div><div class="line">            <span class="keyword">self</span>::$_objList[$config_name] = &amp;$obj;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$_objList[$config_name];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取缓存的静态方法</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string|array $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $clusterId cluster id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sGet</span><span class="params">($key)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $instance = <span class="keyword">self</span>::getInstance();</div><div class="line">        <span class="keyword">return</span> $instance-&gt;get($key);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 设置缓存的静态方法</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $val</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $expires 过期时间（秒），0为永不过期</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $clusterId cluster id</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sSet</span><span class="params">($key, $val, $compress = MEMCACHE_COMPRESSED, $expires = <span class="number">0</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $instance = <span class="keyword">self</span>::getInstance();</div><div class="line">        <span class="keyword">return</span> $instance-&gt;set($key, $val, $compress, $expires);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 删除缓存数据的静态方法</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $clusterId</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sDelete</span><span class="params">($key)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $instance = <span class="keyword">self</span>::getInstance();</div><div class="line">        <span class="keyword">return</span> $instance-&gt;delete($key);    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 增加缓存的静态方法</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $val</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $expires</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $clusterId</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sAdd</span><span class="params">($key, $val, $compress = MEMCACHE_COMPRESSED, $expires = <span class="number">0</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $instance = <span class="keyword">self</span>::getInstance();</div><div class="line">        <span class="keyword">return</span> $instance-&gt;add($key, $val, $compress, $expires);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取缓存数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> mixed </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $res = <span class="keyword">$this</span>-&gt;_memcache-&gt;get($key);</div><div class="line">        <span class="keyword">return</span> $res;    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 写入缓存</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string  $key  数据对应的键名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> mixed   $val  数据</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $expires 缓存的时间（秒），设置为0表示永不过期</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $val, $expires = <span class="number">0</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (is_numeric($val)) &#123;</div><div class="line">            $val = (string) $val;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $ret = <span class="keyword">$this</span>-&gt;_memcache-&gt;set($key, $val, <span class="number">0</span>, $expires);  <span class="comment">//兼容以前程序，直接写0</span></div><div class="line">        </div><div class="line">        <span class="keyword">return</span> $ret;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 删除缓存</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key 数据的键名</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($key)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        $ret = <span class="keyword">$this</span>-&gt;_memcache-&gt;delete($key, <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $ret;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 增加item的值</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $val</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">($key, $val = <span class="number">1</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $ret = <span class="keyword">$this</span>-&gt;_memcache-&gt;increment($key, $val);</div><div class="line">        <span class="keyword">return</span> $ret;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 写入缓存当且仅当$key对应缓存不存在的时候</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> mixed  $val</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> integer $expires</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($key, $val, $compress = MEMCACHE_COMPRESSED, $expires = <span class="number">0</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $ret = <span class="keyword">$this</span>-&gt;_memcache-&gt;add($key, $val, $compress, $expires);</div><div class="line">        <span class="keyword">return</span> $ret;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 刷新</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">flush</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_memcache)) &#123;</div><div class="line">            <span class="keyword">if</span> ( ! <span class="keyword">$this</span>-&gt;init()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $ret = <span class="keyword">$this</span>-&gt;_memcache-&gt;flush();</div><div class="line">        <span class="keyword">return</span> $ret;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper_Kafka</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $__kafka_addr = <span class="string">'127.0.0.1:9092'</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $error = <span class="string">''</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">sendToDp</span><span class="params">($auth, $input_data, $check_data = TRUE, $ip = NULL, $topic = <span class="string">'dp_test'</span>)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(!is_array($auth))&#123;</div><div class="line">            <span class="keyword">self</span>::$error = <span class="string">'auth mot match'</span>;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        $check_auth = Service_Device::checkAuth($auth);</div><div class="line">        <span class="keyword">if</span>(!$check_auth)&#123;</div><div class="line">            <span class="keyword">self</span>::$error = <span class="string">'auth failed'</span>;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">        &#125;</div><div class="line">        $check_dp = Service_Datapoints::checkPostDp($input_data);</div><div class="line">        $input_kafka_array = [];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($ip))&#123;</div><div class="line">           $input_kafka_array[<span class="string">'ip'</span>] = Service_Http::getClientIP();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            $input_kafka_array[<span class="string">'ip'</span>] = $ip;</div><div class="line">        &#125;</div><div class="line">        $input_kafka_array[<span class="string">'auth'</span>] = $auth;</div><div class="line">        $input_kafka_array[<span class="string">'data'</span>] = $input_data;</div><div class="line">        $input_kafka = json_encode($input_kafka_array, JSON_UNESCAPED_UNICODE);</div><div class="line">        <span class="keyword">if</span>($check_dp)&#123;</div><div class="line">            <span class="keyword">self</span>::storeToLocal($auth[<span class="string">'dev_id'</span>], $input_data);</div><div class="line">            $kafka = <span class="keyword">new</span> Kafka(<span class="keyword">self</span>::$__kafka_addr);</div><div class="line">            $res = $kafka-&gt;produce($topic, $input_kafka);</div><div class="line">            $kafka = <span class="keyword">NULL</span>;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">TRUE</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">self</span>::$error = Service_Datapoints::$error;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">storeToLocal</span><span class="params">($dev_id, $input_data)</span></span>&#123;</div><div class="line">        $cache = Cache_Memcached::getInstance();</div><div class="line">        $cache-&gt;set($dev_id,$input_data, <span class="number">80000</span>*<span class="number">30</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><div class="tags"><a href="/blog/public/tags/PHP/">PHP</a><a href="/blog/public/tags/EDP/">EDP</a><a href="/blog/public/tags/协议/">协议</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/blog/public/cjq6du8df0024jkutq7uwg0ro.html" class="pre">使用docker搭建LNMP</a><a href="/blog/public/cjq6du87a000ijkutt460wgal.html" class="next">开发一个新框架-Hachi</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术准备"><span class="toc-text">技术准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一个合适的常驻内存运行的PHP框架"><span class="toc-text">一个合适的常驻内存运行的PHP框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两个重要PHP内置方法"><span class="toc-text">两个重要PHP内置方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一个进制转换方法"><span class="toc-text">一个进制转换方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#看文档做解析"><span class="toc-text">看文档做解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#怎样才能将设备上报的数据转换成方便操作的数据"><span class="toc-text">怎样才能将设备上报的数据转换成方便操作的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理消息类型（第一个字节）"><span class="toc-text">处理消息类型（第一个字节）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接鉴权的处理"><span class="toc-text">连接鉴权的处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#心跳包的处理"><span class="toc-text">心跳包的处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整示例："><span class="toc-text">完整示例：</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du8df0024jkutq7uwg0ro.html">使用docker搭建LNMP</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du8ge002cjkutaqp8my3h.html">基于swoole PHP实现EDP协议服务端</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du87a000ijkutt460wgal.html">开发一个新框架-Hachi</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du87c000pjkut2w82cyel.html">线程相关概念以及pthread</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du87b000njkutlyp63d0f.html">用C语言创建一个守护进程并使用定时器</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du873000ajkutge1avybr.html">makefile相关概念</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du86v0002jkutokaoa6n0.html">hibernate介绍与快速入门</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du86n0000jkute9wesbdk.html">gcc相关概念</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du86z0005jkutt94dzuaz.html">linux vim详解</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/public/cjq6du875000bjkuttmb8agh3.html">linux压缩和解压缩相关技术</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/public/categories/C语言/">C语言</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/public/categories/IT技术/">IT技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/public/categories/PHP/">PHP</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/public/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/public/categories/服务器/">服务器</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/blog/public/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/blog/public/tags/linux/" style="font-size: 15px;">linux</a> <a href="/blog/public/tags/web/" style="font-size: 15px;">web</a> <a href="/blog/public/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/blog/public/tags/文件/" style="font-size: 15px;">文件</a> <a href="/blog/public/tags/shell/" style="font-size: 15px;">shell</a> <a href="/blog/public/tags/git/" style="font-size: 15px;">git</a> <a href="/blog/public/tags/编译技术/" style="font-size: 15px;">编译技术</a> <a href="/blog/public/tags/博客/" style="font-size: 15px;">博客</a> <a href="/blog/public/tags/架构/" style="font-size: 15px;">架构</a> <a href="/blog/public/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/blog/public/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/blog/public/tags/容器化/" style="font-size: 15px;">容器化</a> <a href="/blog/public/tags/EDP/" style="font-size: 15px;">EDP</a> <a href="/blog/public/tags/协议/" style="font-size: 15px;">协议</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/public/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/public/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/public/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/public/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/public/archives/2017/10/">October 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="https://open.iot.10086.cn/" title="OneNET" target="_blank">OneNET</a><ul></ul><a href="https://github.com/limao777" title="My Github" target="_blank">My Github</a><ul></ul><a href="http://michaellee.gitee.io" title="gitee.io" target="_blank">gitee.io</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/blog/public/about/">About</a></p><p><span> Copyright&copy;2017 <a href="/blog/public/." rel="nofollow">Michael Lee.</a></span><span> Theme BlueLake.</span><span> Powered by Hexo.</span></p></div></div></div><script type="text/javascript" src="/blog/public/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/blog/public/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>